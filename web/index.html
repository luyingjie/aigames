<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–—åœ°ä¸»æ¸¸æˆ</title>
    <link rel="stylesheet" href="./css/style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>ğŸƒ æ–—åœ°ä¸»æ¸¸æˆ</h1>
                <p v-if="currentUser">æ¬¢è¿ï¼Œ{{ currentUser.name }}ï¼</p>
            </div>

            <!-- ç™»å½•/æ³¨å†Œç•Œé¢ -->
            <div v-if="currentView === 'login'" class="card">
                <div style="max-width: 400px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 30px;">
                        {{ isLogin ? 'ç™»å½•' : 'æ³¨å†Œ' }}
                    </h2>

                    <div v-if="error" class="error">{{ error }}</div>
                    <div v-if="success" class="success">{{ success }}</div>

                    <form @submit.prevent="submitAuth">
                        <div class="form-group">
                            <label>ç”¨æˆ·å</label>
                            <input v-model="authForm.name" type="text" required>
                        </div>
                        <div class="form-group">
                            <label>å¯†ç </label>
                            <input v-model="authForm.password" type="password" required>
                        </div>
                        <div v-if="!isLogin" class="form-group">
                            <label>å¹´é¾„</label>
                            <input v-model="authForm.age" type="number" min="1" max="150" required>
                        </div>
                        <div style="text-align: center;">
                            <button type="submit" class="btn btn-primary" :disabled="loading">
                                {{ loading ? 'å¤„ç†ä¸­...' : (isLogin ? 'ç™»å½•' : 'æ³¨å†Œ') }}
                            </button>
                        </div>
                    </form>

                    <div style="text-align: center; margin-top: 20px;">
                        <span>{{ isLogin ? 'æ²¡æœ‰è´¦å·ï¼Ÿ' : 'å·²æœ‰è´¦å·ï¼Ÿ' }}</span>
                        <a href="#" @click.prevent="toggleAuthMode" style="color: #2196F3;">
                            {{ isLogin ? 'ç«‹å³æ³¨å†Œ' : 'ç«‹å³ç™»å½•' }}
                        </a>
                    </div>
                </div>
            </div>

            <!-- æˆ¿é—´åˆ—è¡¨ç•Œé¢ -->
            <div v-if="currentView === 'rooms'" class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>æˆ¿é—´åˆ—è¡¨</h2>
                    <div>
                        <button @click="showCreateRoomModal = true" class="btn btn-primary">åˆ›å»ºæˆ¿é—´</button>
                        <button @click="refreshRooms" class="btn btn-secondary">åˆ·æ–°</button>
                        <button @click="logout" class="btn btn-danger">é€€å‡ºç™»å½•</button>
                    </div>
                </div>

                <div v-if="loading" class="loading">åŠ è½½ä¸­...</div>

                <div v-if="rooms.length === 0 && !loading" style="text-align: center; color: #666; padding: 40px;">
                    æš‚æ— æˆ¿é—´ï¼Œç‚¹å‡»"åˆ›å»ºæˆ¿é—´"å¼€å§‹æ¸¸æˆ
                </div>

                <div v-else class="room-list">
                    <div v-for="room in rooms" :key="room.id" class="room-card">
                        <div class="room-header">
                            <div class="room-name">{{ room.name }}</div>
                            <div :class="['room-status', 'status-' + room.status]">
                                {{ room.status_name }}
                            </div>
                        </div>
                        <div style="margin: 10px 0;">
                            <div>æˆ¿ä¸»: {{ room.owner }}</div>
                            <div>ç©å®¶: {{ room.player_count }}/{{ room.max_players }}</div>
                            <div v-if="room.has_password">ğŸ”’ éœ€è¦å¯†ç </div>
                        </div>
                        <div style="text-align: center;">
                            <button @click="joinRoom(room)" class="btn btn-secondary"
                                    :disabled="room.player_count >= room.max_players || room.status === 2">
                                {{ room.status === 2 ? 'æ¸¸æˆä¸­' : (room.player_count >= room.max_players ? 'æˆ¿é—´å·²æ»¡' : 'åŠ å…¥æˆ¿é—´') }}
                            </button>
                            <button v-if="room.owner === currentUser.name" 
                                    @click="deleteRoom(room)" 
                                    class="btn btn-danger"
                                    style="margin-left: 10px;">
                                åˆ é™¤
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¸¸æˆç•Œé¢ -->
            <div v-if="currentView === 'game'">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>æˆ¿é—´: {{ currentRoom?.name }}</h2>
                        <div>
                            <button v-if="gameState?.status === 0 && currentRoom?.owner === currentUser?.name"
                                    @click="startGame" class="btn btn-primary"
                                    :disabled="!allPlayersReady">å¼€å§‹æ¸¸æˆ</button>
                            <button v-if="gameState?.status === 0"
                                    @click="toggleReady"
                                    :class="['btn', playerReady ? 'btn-danger' : 'btn-primary']">
                                {{ playerReady ? 'å–æ¶ˆå‡†å¤‡' : 'å‡†å¤‡' }}
                            </button>
                            <button @click="leaveRoom" class="btn btn-danger">ç¦»å¼€æˆ¿é—´</button>
                        </div>
                    </div>

                    <div v-if="error" class="error">{{ error }}</div>
                    
                    <!-- æ¸¸æˆç»“æŸæç¤º -->
                    <div v-if="gameState?.status === 5" class="success" style="text-align: center; padding: 20px; font-size: 1.2em;">
                        <h3>ğŸ‰ æ¸¸æˆç»“æŸï¼</h3>
                        <p>è·èƒœè€…: ç©å®¶{{ (gameState.winner + 1) }} ({{ getPlayerNameByPosition(gameState.winner) }})</p>
                        <p>{{ gameState.status_name }}</p>
                    </div>

                    <!-- æ¸¸æˆæ¡Œé¢ -->
                    <div class="game-table">
                        <!-- ç©å®¶ä½ç½® (æ ¹æ®å½“å‰ç”¨æˆ·ä½ç½®è°ƒæ•´æ˜¾ç¤º) -->
                        <div class="player-position position-bottom" :class="{ landlord: getPlayerByPosition(0)?.role === 1 }">
                            <div v-if="getPlayerByPosition(0)">
                                {{ getPlayerByPosition(0).username }}
                                <span v-if="getPlayerByPosition(0).username === currentUser.name">(ä½ )</span>
                                <span v-if="getPlayerByPosition(0).is_ai" style="color: #ff9800;">ğŸ¤– AI</span>
                                <div>{{ getPlayerByPosition(0).role_name }}</div>
                                <div>æ‰‹ç‰Œ: {{ getPlayerByPosition(0).card_count }}</div>
                                <div v-if="getPlayerByPosition(0).is_ready">âœ“ å·²å‡†å¤‡</div>
                            </div>
                            <div v-else>ç­‰å¾…ç©å®¶...</div>
                        </div>

                        <div class="player-position position-left" :class="{ landlord: getPlayerByPosition(1)?.role === 1 }">
                            <div v-if="getPlayerByPosition(1)">
                                {{ getPlayerByPosition(1).username }}
                                <span v-if="getPlayerByPosition(1).is_ai" style="color: #ff9800;">ğŸ¤– AI</span>
                                <div>{{ getPlayerByPosition(1).role_name }}</div>
                                <div>æ‰‹ç‰Œ: {{ getPlayerByPosition(1).card_count }}</div>
                                <div v-if="getPlayerByPosition(1).is_ready">âœ“ å·²å‡†å¤‡</div>
                            </div>
                            <div v-else>ç­‰å¾…ç©å®¶...</div>
                        </div>

                        <div class="player-position position-right" :class="{ landlord: getPlayerByPosition(2)?.role === 1 }">
                            <div v-if="getPlayerByPosition(2)">
                                {{ getPlayerByPosition(2).username }}
                                <span v-if="getPlayerByPosition(2).is_ai" style="color: #ff9800;">ğŸ¤– AI</span>
                                <div>{{ getPlayerByPosition(2).role_name }}</div>
                                <div>æ‰‹ç‰Œ: {{ getPlayerByPosition(2).card_count }}</div>
                                <div v-if="getPlayerByPosition(2).is_ready">âœ“ å·²å‡†å¤‡</div>
                            </div>
                            <div v-else>ç­‰å¾…ç©å®¶...</div>
                        </div>

                        <!-- æ¸¸æˆçŠ¶æ€ -->
                        <div class="game-center">
                            <div>{{ gameState?.status_name || 'ç­‰å¾…å¼€å§‹' }}</div>
                            <div v-if="gameState?.current_turn !== undefined">
                                å½“å‰å›åˆ: ç©å®¶{{ gameState.current_turn + 1 }} ({{ getPlayerNameByPosition(gameState.current_turn) }})
                            </div>
                            <div v-if="gameState?.landlord_cards && gameState.landlord_cards.length > 0">
                                <div style="margin-top: 10px;">åœ°ä¸»ç‰Œ:</div>
                                <div class="playing-cards" style="margin: 0;">
                                    <div v-for="(card, index) in gameState.landlord_cards" :key="'landlord-' + index"
                                         :class="['poker-card', getCardColorClass(card)]">
                                        <div class="card-top">{{ formatCardValue(card) }}</div>
                                        <div class="card-center">{{ formatCardSuit(card) }}</div>
                                        <div class="card-bottom">{{ formatCardValue(card) }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸Šä¸€æ¬¡å‡ºç‰Œ -->
                    <div v-if="gameState?.last_play_cards && gameState.last_play_cards.length > 0" class="last-cards">
                        <div class="last-cards-title">ä¸Šä¸€æ‰‹ç‰Œ (ç©å®¶{{ gameState.last_player + 1 }} - {{ getPlayerNameByPosition(gameState.last_player) }})</div>
                        <div class="playing-cards">
                            <div v-for="(card, index) in gameState.last_play_cards" :key="'last-' + index"
                                 :class="['poker-card', getCardColorClass(card)]">
                                <div class="card-top">{{ formatCardValue(card) }}</div>
                                <div class="card-center">{{ formatCardSuit(card) }}</div>
                                <div class="card-bottom">{{ formatCardValue(card) }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- ç©å®¶æ‰‹ç‰Œ -->
                    <div v-if="playerHand && playerHand.length > 0" style="margin-top: 30px;">
                        <h3>æˆ‘çš„æ‰‹ç‰Œ ({{ playerHand.length }}å¼ )</h3>
                        <div class="playing-cards">
                            <div v-for="(card, index) in playerHand" :key="index"
                                 :class="['poker-card', getCardColorClass(card), { selected: selectedCards.includes(index) }]"
                                 @click="toggleCardSelection(index)">
                                <div class="card-top">{{ formatCardValue(card) }}</div>
                                <div class="card-center">{{ formatCardSuit(card) }}</div>
                                <div class="card-bottom">{{ formatCardValue(card) }}</div>
                            </div>
                        </div>

                        <div style="margin-top: 20px; text-align: center;" v-if="isMyTurn && gameState?.status === 4">
                            <button @click="playCards" class="btn btn-primary"
                                    :disabled="selectedCards.length === 0">å‡ºç‰Œ</button>
                            <button @click="passTurn" class="btn btn-secondary"
                                    v-if="gameState?.last_play_cards && gameState.last_play_cards.length > 0 && gameState.last_player !== myPlayerPosition">è¿‡ç‰Œ</button>
                        </div>
                    </div>

                    <!-- å«åœ°ä¸»æŒ‰é’® -->
                    <div v-if="gameState?.status === 3 && isMyTurn" style="text-align: center; margin-top: 20px;">
                        <h3>æ˜¯å¦å«åœ°ä¸»ï¼Ÿ</h3>
                        <button @click="callLandlord(true)" class="btn btn-primary">å«åœ°ä¸»</button>
                        <button @click="callLandlord(false)" class="btn btn-secondary">ä¸å«</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆ›å»ºæˆ¿é—´æ¨¡æ€æ¡† -->
        <div :class="['modal', { show: showCreateRoomModal }]">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px;">åˆ›å»ºæˆ¿é—´</h3>

                <div v-if="error" class="error">{{ error }}</div>

                <form @submit.prevent="createRoom">
                    <div class="form-group">
                        <label>æˆ¿é—´åç§°</label>
                        <input v-model="createRoomForm.name" type="text" required>
                    </div>
                    <div class="form-group">
                        <label>æˆ¿é—´ç±»å‹</label>
                        <select v-model="createRoomForm.type">
                            <option value="0">å…¬å¼€æˆ¿é—´</option>
                            <option value="1">ç§äººæˆ¿é—´</option>
                        </select>
                    </div>
                    <div v-if="createRoomForm.type === '1'" class="form-group">
                        <label>æˆ¿é—´å¯†ç </label>
                        <input v-model="createRoomForm.password" type="password">
                    </div>
                    <div class="form-group">
                        <label>AIç©å®¶æ•°é‡</label>
                        <select v-model="createRoomForm.ai_count">
                            <option value="0">æ— AIç©å®¶</option>
                            <option value="1">1ä¸ªAIç©å®¶</option>
                            <option value="2">2ä¸ªAIç©å®¶</option>
                        </select>
                        <small style="display: block; color: #666; margin-top: 5px;">
                            æ·»åŠ AIç©å®¶å¯ä»¥è®©ä½ ç‹¬è‡ªç»ƒä¹ æˆ–åœ¨äººæ•°ä¸è¶³æ—¶æ¸¸æˆ
                        </small>
                    </div>
                    <div style="text-align: center;">
                        <button type="submit" class="btn btn-primary" :disabled="loading">
                            {{ loading ? 'åˆ›å»ºä¸­...' : 'åˆ›å»ºæˆ¿é—´' }}
                        </button>
                        <button type="button" @click="showCreateRoomModal = false" class="btn btn-secondary">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- åŠ å…¥æˆ¿é—´å¯†ç è¾“å…¥æ¡† -->
        <div :class="['modal', { show: showJoinRoomModal }]">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px;">è¾“å…¥æˆ¿é—´å¯†ç </h3>

                <div v-if="error" class="error">{{ error }}</div>

                <form @submit.prevent="doJoinRoom">
                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input v-model="joinRoomPassword" type="password" required>
                    </div>
                    <div style="text-align: center;">
                        <button type="submit" class="btn btn-primary" :disabled="loading">
                            {{ loading ? 'åŠ å…¥ä¸­...' : 'åŠ å…¥æˆ¿é—´' }}
                        </button>
                        <button type="button" @click="showJoinRoomModal = false" class="btn btn-secondary">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="./js/protocol.js"></script>
    <script src="./js/nano-websocket-client.js"></script>
    <script src="./js/app.js"></script>
</body>
</html>