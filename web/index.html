<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊñóÂú∞‰∏ªÊ∏∏Êàè</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
            transform: translateY(-2px);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .room-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .room-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .room-card:hover {
            transform: translateY(-5px);
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .room-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .room-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-idle {
            background: #e8f5e8;
            color: #4CAF50;
        }

        .status-waiting {
            background: #fff3cd;
            color: #856404;
        }

        .status-playing {
            background: #f8d7da;
            color: #721c24;
        }

        .game-table {
            background: #0d6832;
            border-radius: 50%;
            width: 600px;
            height: 400px;
            margin: 50px auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .player-position {
            position: absolute;
            width: 120px;
            height: 80px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-size: 14px;
        }

        .position-bottom {
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
        }

        .position-left {
            top: 50%;
            left: -60px;
            transform: translateY(-50%);
        }

        .position-right {
            top: 50%;
            right: -60px;
            transform: translateY(-50%);
        }

        .playing-cards {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .card-item {
            width: 40px;
            height: 60px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: bold;
        }

        .card-item.red {
            color: red;
        }

        .card-item.black {
            color: black;
        }

        .card-item:hover {
            transform: translateY(-5px);
        }

        .card-item.selected {
            transform: translateY(-10px);
            background: #ffeb3b;
            border-color: #ff9800;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .error {
            color: #f44336;
            text-align: center;
            padding: 10px;
            background: #ffebee;
            border-radius: 4px;
            margin: 10px 0;
        }

        .success {
            color: #4CAF50;
            text-align: center;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 4px;
            margin: 10px 0;
        }

        .hidden {
            display: none;
        }

        .landlord {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            border: 2px solid #ff9800;
        }

        .game-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            min-width: 200px;
        }

        .last-cards {
            margin-top: 20px;
            text-align: center;
        }

        .last-cards-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>üÉè ÊñóÂú∞‰∏ªÊ∏∏Êàè</h1>
                <p v-if="currentUser">Ê¨¢ËøéÔºå{{ currentUser.name }}ÔºÅ</p>
            </div>

            <!-- ÁôªÂΩï/Ê≥®ÂÜåÁïåÈù¢ -->
            <div v-if="currentView === 'login'" class="card">
                <div style="max-width: 400px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 30px;">
                        {{ isLogin ? 'ÁôªÂΩï' : 'Ê≥®ÂÜå' }}
                    </h2>

                    <div v-if="error" class="error">{{ error }}</div>
                    <div v-if="success" class="success">{{ success }}</div>

                    <form @submit.prevent="submitAuth">
                        <div class="form-group">
                            <label>Áî®Êà∑Âêç</label>
                            <input v-model="authForm.name" type="text" required>
                        </div>
                        <div class="form-group">
                            <label>ÂØÜÁ†Å</label>
                            <input v-model="authForm.password" type="password" required>
                        </div>
                        <div v-if="!isLogin" class="form-group">
                            <label>Âπ¥ÈæÑ</label>
                            <input v-model="authForm.age" type="number" min="1" max="150" required>
                        </div>
                        <div style="text-align: center;">
                            <button type="submit" class="btn btn-primary" :disabled="loading">
                                {{ loading ? 'Â§ÑÁêÜ‰∏≠...' : (isLogin ? 'ÁôªÂΩï' : 'Ê≥®ÂÜå') }}
                            </button>
                        </div>
                    </form>

                    <div style="text-align: center; margin-top: 20px;">
                        <span>{{ isLogin ? 'Ê≤°ÊúâË¥¶Âè∑Ôºü' : 'Â∑≤ÊúâË¥¶Âè∑Ôºü' }}</span>
                        <a href="#" @click.prevent="toggleAuthMode" style="color: #2196F3;">
                            {{ isLogin ? 'Á´ãÂç≥Ê≥®ÂÜå' : 'Á´ãÂç≥ÁôªÂΩï' }}
                        </a>
                    </div>
                </div>
            </div>

            <!-- ÊàøÈó¥ÂàóË°®ÁïåÈù¢ -->
            <div v-if="currentView === 'rooms'" class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ÊàøÈó¥ÂàóË°®</h2>
                    <div>
                        <button @click="showCreateRoomModal = true" class="btn btn-primary">ÂàõÂª∫ÊàøÈó¥</button>
                        <button @click="refreshRooms" class="btn btn-secondary">Âà∑Êñ∞</button>
                        <button @click="logout" class="btn btn-danger">ÈÄÄÂá∫ÁôªÂΩï</button>
                    </div>
                </div>

                <div v-if="loading" class="loading">Âä†ËΩΩ‰∏≠...</div>

                <div v-if="rooms.length === 0 && !loading" style="text-align: center; color: #666; padding: 40px;">
                    ÊöÇÊó†ÊàøÈó¥ÔºåÁÇπÂáª"ÂàõÂª∫ÊàøÈó¥"ÂºÄÂßãÊ∏∏Êàè
                </div>

                <div v-else class="room-list">
                    <div v-for="room in rooms" :key="room.id" class="room-card">
                        <div class="room-header">
                            <div class="room-name">{{ room.name }}</div>
                            <div :class="['room-status', 'status-' + room.status]">
                                {{ room.status_name }}
                            </div>
                        </div>
                        <div style="margin: 10px 0;">
                            <div>Êàø‰∏ª: {{ room.owner }}</div>
                            <div>Áé©ÂÆ∂: {{ room.player_count }}/{{ room.max_players }}</div>
                            <div v-if="room.has_password">üîí ÈúÄË¶ÅÂØÜÁ†Å</div>
                        </div>
                        <div style="text-align: center;">
                            <button @click="joinRoom(room)" class="btn btn-secondary"
                                    :disabled="room.player_count >= room.max_players">
                                {{ room.player_count >= room.max_players ? 'ÊàøÈó¥Â∑≤Êª°' : 'Âä†ÂÖ•ÊàøÈó¥' }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ê∏∏ÊàèÁïåÈù¢ -->
            <div v-if="currentView === 'game'">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>ÊàøÈó¥: {{ currentRoom?.name }}</h2>
                        <div>
                            <button v-if="gameState?.status === 0 && currentRoom?.owner === currentUser?.name"
                                    @click="startGame" class="btn btn-primary"
                                    :disabled="!allPlayersReady">ÂºÄÂßãÊ∏∏Êàè</button>
                            <button v-if="gameState?.status === 0"
                                    @click="toggleReady"
                                    :class="['btn', playerReady ? 'btn-danger' : 'btn-primary']">
                                {{ playerReady ? 'ÂèñÊ∂àÂáÜÂ§á' : 'ÂáÜÂ§á' }}
                            </button>
                            <button @click="leaveRoom" class="btn btn-danger">Á¶ªÂºÄÊàøÈó¥</button>
                        </div>
                    </div>

                    <div v-if="error" class="error">{{ error }}</div>

                    <!-- Ê∏∏ÊàèÊ°åÈù¢ -->
                    <div class="game-table">
                        <!-- Áé©ÂÆ∂‰ΩçÁΩÆ -->
                        <div class="player-position position-bottom" :class="{ landlord: gameState?.players[0]?.role === 1 }">
                            <div v-if="gameState?.players[0]">
                                {{ gameState.players[0].username }}
                                <div>{{ gameState.players[0].role_name }}</div>
                                <div>ÊâãÁâå: {{ gameState.players[0].card_count }}</div>
                                <div v-if="gameState.players[0].is_ready">‚úì Â∑≤ÂáÜÂ§á</div>
                            </div>
                            <div v-else>Á≠âÂæÖÁé©ÂÆ∂...</div>
                        </div>

                        <div class="player-position position-left" :class="{ landlord: gameState?.players[1]?.role === 1 }">
                            <div v-if="gameState?.players[1]">
                                {{ gameState.players[1].username }}
                                <div>{{ gameState.players[1].role_name }}</div>
                                <div>ÊâãÁâå: {{ gameState.players[1].card_count }}</div>
                                <div v-if="gameState.players[1].is_ready">‚úì Â∑≤ÂáÜÂ§á</div>
                            </div>
                            <div v-else>Á≠âÂæÖÁé©ÂÆ∂...</div>
                        </div>

                        <div class="player-position position-right" :class="{ landlord: gameState?.players[2]?.role === 1 }">
                            <div v-if="gameState?.players[2]">
                                {{ gameState.players[2].username }}
                                <div>{{ gameState.players[2].role_name }}</div>
                                <div>ÊâãÁâå: {{ gameState.players[2].card_count }}</div>
                                <div v-if="gameState.players[2].is_ready">‚úì Â∑≤ÂáÜÂ§á</div>
                            </div>
                            <div v-else>Á≠âÂæÖÁé©ÂÆ∂...</div>
                        </div>

                        <!-- Ê∏∏ÊàèÁä∂ÊÄÅ -->
                        <div class="game-center">
                            <div>{{ gameState?.status_name || 'Á≠âÂæÖÂºÄÂßã' }}</div>
                            <div v-if="gameState?.current_turn !== undefined">
                                ÂΩìÂâçÂõûÂêà: Áé©ÂÆ∂{{ gameState.current_turn + 1 }}
                            </div>
                            <div v-if="gameState?.landlord_cards && gameState.landlord_cards.length > 0">
                                <div style="margin-top: 10px;">Âú∞‰∏ªÁâå:</div>
                                <div class="playing-cards" style="margin: 0;">
                                    <div v-for="(card, index) in gameState.landlord_cards" :key="'landlord-' + index"
                                         :class="['card-item', getCardColor(card)]">
                                        {{ formatCard(card) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ‰∏ä‰∏ÄÊ¨°Âá∫Áâå -->
                    <div v-if="gameState?.last_play_cards && gameState.last_play_cards.length > 0" class="last-cards">
                        <div class="last-cards-title">‰∏ä‰∏ÄÊâãÁâå (Áé©ÂÆ∂{{ gameState.last_player + 1 }})</div>
                        <div class="playing-cards">
                            <div v-for="(card, index) in gameState.last_play_cards" :key="'last-' + index"
                                 :class="['card-item', getCardColor(card)]">
                                {{ formatCard(card) }}
                            </div>
                        </div>
                    </div>

                    <!-- Áé©ÂÆ∂ÊâãÁâå -->
                    <div v-if="playerHand && playerHand.length > 0" style="margin-top: 30px;">
                        <h3>ÊàëÁöÑÊâãÁâå ({{ playerHand.length }}Âº†)</h3>
                        <div class="playing-cards">
                            <div v-for="(card, index) in playerHand" :key="index"
                                 :class="['card-item', getCardColor(card), { selected: selectedCards.includes(index) }]"
                                 @click="toggleCardSelection(index)">
                                {{ formatCard(card) }}
                            </div>
                        </div>

                        <div style="margin-top: 20px; text-align: center;" v-if="isMyTurn && gameState?.status === 4">
                            <button @click="playCards" class="btn btn-primary"
                                    :disabled="selectedCards.length === 0">Âá∫Áâå</button>
                            <button @click="passTurn" class="btn btn-secondary"
                                    v-if="gameState?.last_play_cards && gameState.last_play_cards.length > 0 && gameState.last_player !== myPlayerPosition">ËøáÁâå</button>
                        </div>
                    </div>

                    <!-- Âè´Âú∞‰∏ªÊåâÈíÆ -->
                    <div v-if="gameState?.status === 3 && isMyTurn" style="text-align: center; margin-top: 20px;">
                        <h3>ÊòØÂê¶Âè´Âú∞‰∏ªÔºü</h3>
                        <button @click="callLandlord(true)" class="btn btn-primary">Âè´Âú∞‰∏ª</button>
                        <button @click="callLandlord(false)" class="btn btn-secondary">‰∏çÂè´</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÂàõÂª∫ÊàøÈó¥Ê®°ÊÄÅÊ°Ü -->
        <div :class="['modal', { show: showCreateRoomModal }]">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px;">ÂàõÂª∫ÊàøÈó¥</h3>

                <div v-if="error" class="error">{{ error }}</div>

                <form @submit.prevent="createRoom">
                    <div class="form-group">
                        <label>ÊàøÈó¥ÂêçÁß∞</label>
                        <input v-model="createRoomForm.name" type="text" required>
                    </div>
                    <div class="form-group">
                        <label>ÊàøÈó¥Á±ªÂûã</label>
                        <select v-model="createRoomForm.type">
                            <option value="0">ÂÖ¨ÂºÄÊàøÈó¥</option>
                            <option value="1">ÁßÅ‰∫∫ÊàøÈó¥</option>
                        </select>
                    </div>
                    <div v-if="createRoomForm.type === '1'" class="form-group">
                        <label>ÊàøÈó¥ÂØÜÁ†Å</label>
                        <input v-model="createRoomForm.password" type="password">
                    </div>
                    <div style="text-align: center;">
                        <button type="submit" class="btn btn-primary" :disabled="loading">
                            {{ loading ? 'ÂàõÂª∫‰∏≠...' : 'ÂàõÂª∫ÊàøÈó¥' }}
                        </button>
                        <button type="button" @click="showCreateRoomModal = false" class="btn btn-secondary">ÂèñÊ∂à</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Âä†ÂÖ•ÊàøÈó¥ÂØÜÁ†ÅËæìÂÖ•Ê°Ü -->
        <div :class="['modal', { show: showJoinRoomModal }]">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px;">ËæìÂÖ•ÊàøÈó¥ÂØÜÁ†Å</h3>

                <div v-if="error" class="error">{{ error }}</div>

                <form @submit.prevent="doJoinRoom">
                    <div class="form-group">
                        <label>ÂØÜÁ†Å</label>
                        <input v-model="joinRoomPassword" type="password" required>
                    </div>
                    <div style="text-align: center;">
                        <button type="submit" class="btn btn-primary" :disabled="loading">
                            {{ loading ? 'Âä†ÂÖ•‰∏≠...' : 'Âä†ÂÖ•ÊàøÈó¥' }}
                        </button>
                        <button type="button" @click="showJoinRoomModal = false" class="btn btn-secondary">ÂèñÊ∂à</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="./js/nano-websocket-client.js"></script>
    <script>
        const { createApp, ref, computed, onMounted, onUnmounted } = Vue;

        const app = createApp({
            setup() {
                // ÂìçÂ∫îÂºèÊï∞ÊçÆ
                const currentView = ref('login'); // login, rooms, game
                const loading = ref(false);
                const error = ref('');
                const success = ref('');

                // Áî®Êà∑ËÆ§ËØÅ
                const isLogin = ref(true);
                const currentUser = ref(null);
                const authForm = ref({
                    name: '',
                    password: '',
                    age: 18
                });

                // ÊàøÈó¥Áõ∏ÂÖ≥
                const rooms = ref([]);
                const currentRoom = ref(null);
                const showCreateRoomModal = ref(false);
                const showJoinRoomModal = ref(false);
                const joinRoomPassword = ref('');
                const selectedRoom = ref(null);
                const createRoomForm = ref({
                    name: '',
                    type: '0',
                    password: ''
                });

                // Ê∏∏ÊàèÁõ∏ÂÖ≥
                const gameState = ref(null);
                const playerHand = ref([]);
                const selectedCards = ref([]);
                const playerReady = ref(false);
                const nano = ref(null);

                // ËÆ°ÁÆóÂ±ûÊÄß
                const isMyTurn = computed(() => {
                    if (!gameState.value || !currentUser.value) return false;
                    const myPlayer = gameState.value.players?.find(p => p && p.username === currentUser.value.name);
                    return myPlayer && myPlayer.position === gameState.value.current_turn;
                });

                const myPlayerPosition = computed(() => {
                    if (!gameState.value || !currentUser.value) return -1;
                    const myPlayer = gameState.value.players?.find(p => p && p.username === currentUser.value.name);
                    return myPlayer ? myPlayer.position : -1;
                });

                const allPlayersReady = computed(() => {
                    if (!gameState.value || !gameState.value.players) return false;
                    const players = gameState.value.players.filter(p => p !== null);
                    return players.length === 3 && players.every(p => p.is_ready);
                });

                // nanoÁõ∏ÂÖ≥ÊñπÊ≥ï
                const initNano = () => {
                    nano.value = window.nano;

                    nano.value.init({
                        host: "127.0.0.1",
                        port: 3250,
                        path: "/nano",
                        log: false,
                        user: {},
                        handshakeCallback: function() {
                            console.log('nanoÊè°ÊâãÂÆåÊàê');
                        }
                    }, function() {
                        console.log('nanoËøûÊé•ÊàêÂäü');
                    });
                };

                const request = (route, data) => {
                    return new Promise((resolve, reject) => {
                        nano.value.request(route, data, function(response) {
                            resolve(response);
                        });
                    });
                };

                // ËÆ§ËØÅÁõ∏ÂÖ≥ÊñπÊ≥ï
                const submitAuth = async () => {
                    if (!authForm.value.name || !authForm.value.password) {
                        error.value = 'ËØ∑Â°´ÂÜôÂÆåÊï¥‰ø°ÊÅØ';
                        return;
                    }

                    loading.value = true;
                    error.value = '';
                    success.value = '';

                    try {
                        const route = isLogin.value ? 'user.Login' : 'user.Signup';
                        const response = await request(route, authForm.value);

                        if (response.code === 200) {
                            success.value = response.message;
                            if (isLogin.value) {
                                currentUser.value = response.data;
                                currentView.value = 'rooms';
                                await refreshRooms();
                            } else {
                                success.value = 'Ê≥®ÂÜåÊàêÂäüÔºåËØ∑ÁôªÂΩï';
                                isLogin.value = true;
                                authForm.value.password = '';
                            }
                        } else {
                            error.value = response.message || 'Êìç‰ΩúÂ§±Ë¥•';
                        }
                    } catch (err) {
                        error.value = 'ÁΩëÁªúÈîôËØØÔºö' + err.message;
                    } finally {
                        loading.value = false;
                    }
                };

                const toggleAuthMode = () => {
                    isLogin.value = !isLogin.value;
                    error.value = '';
                    success.value = '';
                    authForm.value.password = '';
                };

                const logout = () => {
                    currentUser.value = null;
                    currentView.value = 'login';
                    currentRoom.value = null;
                    gameState.value = null;
                    playerHand.value = [];
                };

                // ÊàøÈó¥Áõ∏ÂÖ≥ÊñπÊ≥ï
                const refreshRooms = async () => {
                    loading.value = true;
                    try {
                        const response = await request('room.GetRoomList', {
                            page: 1,
                            size: 50,
                            type: 0
                        });

                        if (response.code === 200) {
                            rooms.value = response.data.rooms || [];
                        } else {
                            error.value = response.message || 'Ëé∑ÂèñÊàøÈó¥ÂàóË°®Â§±Ë¥•';
                        }
                    } catch (err) {
                        error.value = 'ÁΩëÁªúÈîôËØØÔºö' + err.message;
                    } finally {
                        loading.value = false;
                    }
                };

                const createRoom = async () => {
                    if (!createRoomForm.value.name) {
                        error.value = 'ËØ∑ËæìÂÖ•ÊàøÈó¥ÂêçÁß∞';
                        return;
                    }

                    loading.value = true;
                    error.value = '';

                    try {
                        const response = await request('room.CreateRoom', {
                            name: createRoomForm.value.name,
                            type: parseInt(createRoomForm.value.type),
                            password: createRoomForm.value.password
                        });

                        if (response.code === 200) {
                            currentRoom.value = response.data;
                            currentView.value = 'game';
                            showCreateRoomModal.value = false;
                            createRoomForm.value = { name: '', type: '0', password: '' };
                            await getGameState();
                            startGameStatePolling();
                        } else {
                            error.value = response.message || 'ÂàõÂª∫ÊàøÈó¥Â§±Ë¥•';
                        }
                    } catch (err) {
                        error.value = 'ÁΩëÁªúÈîôËØØÔºö' + err.message;
                    } finally {
                        loading.value = false;
                    }
                };

                const joinRoom = (room) => {
                    selectedRoom.value = room;
                    if (room.has_password) {
                        showJoinRoomModal.value = true;
                        joinRoomPassword.value = '';
                    } else {
                        doJoinRoom();
                    }
                };

                const doJoinRoom = async () => {
                    loading.value = true;
                    error.value = '';

                    try {
                        const response = await request('room.JoinRoom', {
                            room_id: selectedRoom.value.id,
                            password: joinRoomPassword.value
                        });

                        if (response.code === 200) {
                            currentRoom.value = response.data;
                            currentView.value = 'game';
                            showJoinRoomModal.value = false;
                            await getGameState();
                            startGameStatePolling();
                        } else {
                            error.value = response.message || 'Âä†ÂÖ•ÊàøÈó¥Â§±Ë¥•';
                        }
                    } catch (err) {
                        error.value = 'ÁΩëÁªúÈîôËØØÔºö' + err.message;
                    } finally {
                        loading.value = false;
                    }
                };

                const leaveRoom = async () => {
                    if (!currentRoom.value) return;

                    try {
                        await request('room.LeaveRoom', {
                            room_id: currentRoom.value.id
                        });
                        currentRoom.value = null;
                        currentView.value = 'rooms';
                        gameState.value = null;
                        playerHand.value = [];
                        stopGameStatePolling();
                        await refreshRooms();
                    } catch (err) {
                        error.value = 'Á¶ªÂºÄÊàøÈó¥Â§±Ë¥•Ôºö' + err.message;
                    }
                };

                // Ê∏∏ÊàèÁõ∏ÂÖ≥ÊñπÊ≥ï
                const getGameState = async () => {
                    if (!currentRoom.value) return;

                    try {
                        const response = await request('game.GetGameState', {
                            room_id: currentRoom.value.id
                        });

                        if (response.code === 200) {
                            gameState.value = response.data;

                            // Ëé∑ÂèñÁé©ÂÆ∂ÊâãÁâå
                            const handResponse = await request('game.GetPlayerHand', {
                                room_id: currentRoom.value.id
                            });

                            if (handResponse.code === 200) {
                                playerHand.value = handResponse.data.cards || [];
                            }

                            // Ê£ÄÊü•Áé©ÂÆ∂ÂáÜÂ§áÁä∂ÊÄÅ
                            const myPlayer = gameState.value.players?.find(p => p && p.username === currentUser.value.name);
                            if (myPlayer) {
                                playerReady.value = myPlayer.is_ready;
                            }
                        }
                    } catch (err) {
                        console.error('Ëé∑ÂèñÊ∏∏ÊàèÁä∂ÊÄÅÂ§±Ë¥•:', err);
                    }
                };

                const toggleReady = async () => {
                    try {
                        const response = await request('room.SetReady', {
                            room_id: currentRoom.value.id,
                            ready: !playerReady.value
                        });

                        if (response.code === 200) {
                            playerReady.value = !playerReady.value;
                            await getGameState();
                        } else {
                            error.value = response.message || 'ËÆæÁΩÆÂáÜÂ§áÁä∂ÊÄÅÂ§±Ë¥•';
                        }
                    } catch (err) {
                        error.value = 'ÁΩëÁªúÈîôËØØÔºö' + err.message;
                    }
                };

                const startGame = async () => {
                    try {
                        const response = await request('room.StartGame', {
                            room_id: currentRoom.value.id
                        });

                        if (response.code === 200) {
                            await getGameState();
                        } else {
                            error.value = response.message || 'ÂºÄÂßãÊ∏∏ÊàèÂ§±Ë¥•';
                        }
                    } catch (err) {
                        error.value = 'ÁΩëÁªúÈîôËØØÔºö' + err.message;
                    }
                };

                const callLandlord = async (call) => {
                    try {
                        const response = await request('game.CallLandlord', {
                            room_id: currentRoom.value.id,
                            call: call
                        });

                        if (response.code === 200) {
                            await getGameState();
                        } else {
                            error.value = response.message || 'Âè´Âú∞‰∏ªÂ§±Ë¥•';
                        }
                    } catch (err) {
                        error.value = 'ÁΩëÁªúÈîôËØØÔºö' + err.message;
                    }
                };

                const toggleCardSelection = (index) => {
                    const pos = selectedCards.value.indexOf(index);
                    if (pos > -1) {
                        selectedCards.value.splice(pos, 1);
                    } else {
                        selectedCards.value.push(index);
                    }
                };

                const playCards = async () => {
                    if (selectedCards.value.length === 0) return;

                    const cards = selectedCards.value.map(index => playerHand.value[index]);

                    try {
                        const response = await request('game.PlayCards', {
                            room_id: currentRoom.value.id,
                            cards: cards
                        });

                        if (response.code === 200) {
                            selectedCards.value = [];
                            await getGameState();
                        } else {
                            error.value = response.message || 'Âá∫ÁâåÂ§±Ë¥•';
                        }
                    } catch (err) {
                        error.value = 'ÁΩëÁªúÈîôËØØÔºö' + err.message;
                    }
                };

                const passTurn = async () => {
                    try {
                        const response = await request('game.PassTurn', {
                            room_id: currentRoom.value.id
                        });

                        if (response.code === 200) {
                            await getGameState();
                        } else {
                            error.value = response.message || 'ËøáÁâåÂ§±Ë¥•';
                        }
                    } catch (err) {
                        error.value = 'ÁΩëÁªúÈîôËØØÔºö' + err.message;
                    }
                };

                // Â∑•ÂÖ∑ÊñπÊ≥ï
                const formatCard = (card) => {
                    const suits = { 1: '‚ô†', 2: '‚ô•', 3: '‚ô¶', 4: '‚ô£', 5: 'Áéã' };
                    const values = {
                        3: '3', 4: '4', 5: '5', 6: '6', 7: '7', 8: '8', 9: '9', 10: '10',
                        11: 'J', 12: 'Q', 13: 'K', 14: 'A', 15: '2',
                        16: 'Â∞èÁéã', 17: 'Â§ßÁéã'
                    };

                    if (card.suit === 5) {
                        return values[card.value];
                    }
                    return suits[card.suit] + values[card.value];
                };

                const getCardColor = (card) => {
                    if (card.suit === 2 || card.suit === 3) { // Á∫¢Ê°ÉÔºåÊñπÂùó
                        return 'red';
                    }
                    return 'black';
                };

                // ÂÆöÊó∂Âà∑Êñ∞Ê∏∏ÊàèÁä∂ÊÄÅ
                let gameStateInterval = null;
                const startGameStatePolling = () => {
                    if (gameStateInterval) clearInterval(gameStateInterval);
                    gameStateInterval = setInterval(() => {
                        if (currentView.value === 'game' && currentRoom.value) {
                            getGameState();
                        }
                    }, 2000);
                };

                const stopGameStatePolling = () => {
                    if (gameStateInterval) {
                        clearInterval(gameStateInterval);
                        gameStateInterval = null;
                    }
                };

                // Ê∏ÖÈô§ÈîôËØØ‰ø°ÊÅØ
                const clearError = () => {
                    error.value = '';
                };

                // ÁîüÂëΩÂë®Êúü
                onMounted(() => {
                    initNano();

                    // ÂÆöÊó∂Ê∏ÖÈô§ÈîôËØØ‰ø°ÊÅØ
                    setInterval(() => {
                        if (error.value) {
                            setTimeout(clearError, 3000);
                        }
                    }, 100);
                });

                onUnmounted(() => {
                    stopGameStatePolling();
                });

                return {
                    // Êï∞ÊçÆ
                    currentView, loading, error, success,
                    isLogin, currentUser, authForm,
                    rooms, currentRoom, showCreateRoomModal, showJoinRoomModal,
                    joinRoomPassword, createRoomForm,
                    gameState, playerHand, selectedCards, playerReady,
                    isMyTurn, myPlayerPosition, allPlayersReady,

                    // ÊñπÊ≥ï
                    submitAuth, toggleAuthMode, logout,
                    refreshRooms, createRoom, joinRoom, doJoinRoom, leaveRoom,
                    getGameState, toggleReady, startGame, callLandlord,
                    toggleCardSelection, playCards, passTurn, formatCard, getCardColor
                };
            }
        });

        app.mount('#app');
    </script>
</body>
</html>