<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–—åœ°ä¸»æ¸¸æˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
            transform: translateY(-2px);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .room-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .room-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .room-card:hover {
            transform: translateY(-5px);
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .room-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .room-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-idle {
            background: #e8f5e8;
            color: #4CAF50;
        }

        .status-waiting {
            background: #fff3cd;
            color: #856404;
        }

        .status-playing {
            background: #f8d7da;
            color: #721c24;
        }

        .game-table {
            background: #0d6832;
            border-radius: 50%;
            width: 600px;
            height: 400px;
            margin: 50px auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .player-position {
            position: absolute;
            width: 120px;
            height: 80px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-size: 14px;
        }

        .position-bottom {
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
        }

        .position-left {
            top: 50%;
            left: -60px;
            transform: translateY(-50%);
        }

        .position-right {
            top: 50%;
            right: -60px;
            transform: translateY(-50%);
        }

        .playing-cards {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .card-item {
            width: 40px;
            height: 60px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: bold;
        }

        .card-item.red {
            color: red;
        }

        .card-item.black {
            color: black;
        }

        .card-item:hover {
            transform: translateY(-5px);
        }

        .card-item.selected {
            transform: translateY(-10px);
            background: #ffeb3b;
            border-color: #ff9800;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .error {
            color: #f44336;
            text-align: center;
            padding: 10px;
            background: #ffebee;
            border-radius: 4px;
            margin: 10px 0;
        }

        .success {
            color: #4CAF50;
            text-align: center;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 4px;
            margin: 10px 0;
        }

        .hidden {
            display: none;
        }

        .landlord {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            border: 2px solid #ff9800;
        }

        .game-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            min-width: 200px;
        }

        .last-cards {
            margin-top: 20px;
            text-align: center;
        }

        .last-cards-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>ğŸƒ æ–—åœ°ä¸»æ¸¸æˆ</h1>
                <p v-if="currentUser">æ¬¢è¿ï¼Œ{{ currentUser.name }}ï¼</p>
            </div>

            <!-- ç™»å½•/æ³¨å†Œç•Œé¢ -->
            <div v-if="currentView === 'login'" class="card">
                <div style="max-width: 400px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 30px;">
                        {{ isLogin ? 'ç™»å½•' : 'æ³¨å†Œ' }}
                    </h2>

                    <div v-if="error" class="error">{{ error }}</div>
                    <div v-if="success" class="success">{{ success }}</div>

                    <form @submit.prevent="submitAuth">
                        <div class="form-group">
                            <label>ç”¨æˆ·å</label>
                            <input v-model="authForm.name" type="text" required>
                        </div>
                        <div class="form-group">
                            <label>å¯†ç </label>
                            <input v-model="authForm.password" type="password" required>
                        </div>
                        <div v-if="!isLogin" class="form-group">
                            <label>å¹´é¾„</label>
                            <input v-model="authForm.age" type="number" min="1" max="150" required>
                        </div>
                        <div style="text-align: center;">
                            <button type="submit" class="btn btn-primary" :disabled="loading">
                                {{ loading ? 'å¤„ç†ä¸­...' : (isLogin ? 'ç™»å½•' : 'æ³¨å†Œ') }}
                            </button>
                        </div>
                    </form>

                    <div style="text-align: center; margin-top: 20px;">
                        <span>{{ isLogin ? 'æ²¡æœ‰è´¦å·ï¼Ÿ' : 'å·²æœ‰è´¦å·ï¼Ÿ' }}</span>
                        <a href="#" @click.prevent="toggleAuthMode" style="color: #2196F3;">
                            {{ isLogin ? 'ç«‹å³æ³¨å†Œ' : 'ç«‹å³ç™»å½•' }}
                        </a>
                    </div>
                </div>
            </div>

            <!-- æˆ¿é—´åˆ—è¡¨ç•Œé¢ -->
            <div v-if="currentView === 'rooms'" class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>æˆ¿é—´åˆ—è¡¨</h2>
                    <div>
                        <button @click="showCreateRoomModal = true" class="btn btn-primary">åˆ›å»ºæˆ¿é—´</button>
                        <button @click="refreshRooms" class="btn btn-secondary">åˆ·æ–°</button>
                        <button @click="logout" class="btn btn-danger">é€€å‡ºç™»å½•</button>
                    </div>
                </div>

                <div v-if="loading" class="loading">åŠ è½½ä¸­...</div>

                <div v-if="rooms.length === 0 && !loading" style="text-align: center; color: #666; padding: 40px;">
                    æš‚æ— æˆ¿é—´ï¼Œç‚¹å‡»"åˆ›å»ºæˆ¿é—´"å¼€å§‹æ¸¸æˆ
                </div>

                <div v-else class="room-list">
                    <div v-for="room in rooms" :key="room.id" class="room-card">
                        <div class="room-header">
                            <div class="room-name">{{ room.name }}</div>
                            <div :class="['room-status', 'status-' + room.status]">
                                {{ room.status_name }}
                            </div>
                        </div>
                        <div style="margin: 10px 0;">
                            <div>æˆ¿ä¸»: {{ room.owner }}</div>
                            <div>ç©å®¶: {{ room.player_count }}/{{ room.max_players }}</div>
                            <div v-if="room.has_password">ğŸ”’ éœ€è¦å¯†ç </div>
                        </div>
                        <div style="text-align: center;">
                            <button @click="joinRoom(room)" class="btn btn-secondary"
                                    :disabled="room.player_count >= room.max_players">
                                {{ room.player_count >= room.max_players ? 'æˆ¿é—´å·²æ»¡' : 'åŠ å…¥æˆ¿é—´' }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¸¸æˆç•Œé¢ -->
            <div v-if="currentView === 'game'">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>æˆ¿é—´: {{ currentRoom?.name }}</h2>
                        <div>
                            <button v-if="gameState?.status === 0 && currentRoom?.owner === currentUser?.name"
                                    @click="startGame" class="btn btn-primary"
                                    :disabled="!allPlayersReady">å¼€å§‹æ¸¸æˆ</button>
                            <button v-if="gameState?.status === 0"
                                    @click="toggleReady"
                                    :class="['btn', playerReady ? 'btn-danger' : 'btn-primary']">
                                {{ playerReady ? 'å–æ¶ˆå‡†å¤‡' : 'å‡†å¤‡' }}
                            </button>
                            <button @click="leaveRoom" class="btn btn-danger">ç¦»å¼€æˆ¿é—´</button>
                        </div>
                    </div>

                    <div v-if="error" class="error">{{ error }}</div>

                    <!-- æ¸¸æˆæ¡Œé¢ -->
                    <div class="game-table">
                        <!-- ç©å®¶ä½ç½® -->
                        <div class="player-position position-bottom" :class="{ landlord: gameState?.players[0]?.role === 1 }">
                            <div v-if="gameState?.players[0]">
                                {{ gameState.players[0].username }}
                                <div>{{ gameState.players[0].role_name }}</div>
                                <div>æ‰‹ç‰Œ: {{ gameState.players[0].card_count }}</div>
                                <div v-if="gameState.players[0].is_ready">âœ“ å·²å‡†å¤‡</div>
                            </div>
                            <div v-else>ç­‰å¾…ç©å®¶...</div>
                        </div>

                        <div class="player-position position-left" :class="{ landlord: gameState?.players[1]?.role === 1 }">
                            <div v-if="gameState?.players[1]">
                                {{ gameState.players[1].username }}
                                <div>{{ gameState.players[1].role_name }}</div>
                                <div>æ‰‹ç‰Œ: {{ gameState.players[1].card_count }}</div>
                                <div v-if="gameState.players[1].is_ready">âœ“ å·²å‡†å¤‡</div>
                            </div>
                            <div v-else>ç­‰å¾…ç©å®¶...</div>
                        </div>

                        <div class="player-position position-right" :class="{ landlord: gameState?.players[2]?.role === 1 }">
                            <div v-if="gameState?.players[2]">
                                {{ gameState.players[2].username }}
                                <div>{{ gameState.players[2].role_name }}</div>
                                <div>æ‰‹ç‰Œ: {{ gameState.players[2].card_count }}</div>
                                <div v-if="gameState.players[2].is_ready">âœ“ å·²å‡†å¤‡</div>
                            </div>
                            <div v-else>ç­‰å¾…ç©å®¶...</div>
                        </div>

                        <!-- æ¸¸æˆçŠ¶æ€ -->
                        <div class="game-center">
                            <div>{{ gameState?.status_name || 'ç­‰å¾…å¼€å§‹' }}</div>
                            <div v-if="gameState?.current_turn !== undefined">
                                å½“å‰å›åˆ: ç©å®¶{{ gameState.current_turn + 1 }}
                            </div>
                            <div v-if="gameState?.landlord_cards && gameState.landlord_cards.length > 0">
                                <div style="margin-top: 10px;">åœ°ä¸»ç‰Œ:</div>
                                <div class="playing-cards" style="margin: 0;">
                                    <div v-for="(card, index) in gameState.landlord_cards" :key="'landlord-' + index"
                                         :class="['card-item', getCardColor(card)]">
                                        {{ formatCard(card) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸Šä¸€æ¬¡å‡ºç‰Œ -->
                    <div v-if="gameState?.last_play_cards && gameState.last_play_cards.length > 0" class="last-cards">
                        <div class="last-cards-title">ä¸Šä¸€æ‰‹ç‰Œ (ç©å®¶{{ gameState.last_player + 1 }})</div>
                        <div class="playing-cards">
                            <div v-for="(card, index) in gameState.last_play_cards" :key="'last-' + index"
                                 :class="['card-item', getCardColor(card)]">
                                {{ formatCard(card) }}
                            </div>
                        </div>
                    </div>

                    <!-- ç©å®¶æ‰‹ç‰Œ -->
                    <div v-if="playerHand && playerHand.length > 0" style="margin-top: 30px;">
                        <h3>æˆ‘çš„æ‰‹ç‰Œ ({{ playerHand.length }}å¼ )</h3>
                        <div class="playing-cards">
                            <div v-for="(card, index) in playerHand" :key="index"
                                 :class="['card-item', getCardColor(card), { selected: selectedCards.includes(index) }]"
                                 @click="toggleCardSelection(index)">
                                {{ formatCard(card) }}
                            </div>
                        </div>

                        <div style="margin-top: 20px; text-align: center;" v-if="isMyTurn && gameState?.status === 4">
                            <button @click="playCards" class="btn btn-primary"
                                    :disabled="selectedCards.length === 0">å‡ºç‰Œ</button>
                            <button @click="passTurn" class="btn btn-secondary"
                                    v-if="gameState?.last_play_cards && gameState.last_play_cards.length > 0 && gameState.last_player !== myPlayerPosition">è¿‡ç‰Œ</button>
                        </div>
                    </div>

                    <!-- å«åœ°ä¸»æŒ‰é’® -->
                    <div v-if="gameState?.status === 3 && isMyTurn" style="text-align: center; margin-top: 20px;">
                        <h3>æ˜¯å¦å«åœ°ä¸»ï¼Ÿ</h3>
                        <button @click="callLandlord(true)" class="btn btn-primary">å«åœ°ä¸»</button>
                        <button @click="callLandlord(false)" class="btn btn-secondary">ä¸å«</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆ›å»ºæˆ¿é—´æ¨¡æ€æ¡† -->
        <div :class="['modal', { show: showCreateRoomModal }]">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px;">åˆ›å»ºæˆ¿é—´</h3>

                <div v-if="error" class="error">{{ error }}</div>

                <form @submit.prevent="createRoom">
                    <div class="form-group">
                        <label>æˆ¿é—´åç§°</label>
                        <input v-model="createRoomForm.name" type="text" required>
                    </div>
                    <div class="form-group">
                        <label>æˆ¿é—´ç±»å‹</label>
                        <select v-model="createRoomForm.type">
                            <option value="0">å…¬å¼€æˆ¿é—´</option>
                            <option value="1">ç§äººæˆ¿é—´</option>
                        </select>
                    </div>
                    <div v-if="createRoomForm.type === '1'" class="form-group">
                        <label>æˆ¿é—´å¯†ç </label>
                        <input v-model="createRoomForm.password" type="password">
                    </div>
                    <div style="text-align: center;">
                        <button type="submit" class="btn btn-primary" :disabled="loading">
                            {{ loading ? 'åˆ›å»ºä¸­...' : 'åˆ›å»ºæˆ¿é—´' }}
                        </button>
                        <button type="button" @click="showCreateRoomModal = false" class="btn btn-secondary">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- åŠ å…¥æˆ¿é—´å¯†ç è¾“å…¥æ¡† -->
        <div :class="['modal', { show: showJoinRoomModal }]">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px;">è¾“å…¥æˆ¿é—´å¯†ç </h3>

                <div v-if="error" class="error">{{ error }}</div>

                <form @submit.prevent="doJoinRoom">
                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input v-model="joinRoomPassword" type="password" required>
                    </div>
                    <div style="text-align: center;">
                        <button type="submit" class="btn btn-primary" :disabled="loading">
                            {{ loading ? 'åŠ å…¥ä¸­...' : 'åŠ å…¥æˆ¿é—´' }}
                        </button>
                        <button type="button" @click="showJoinRoomModal = false" class="btn btn-secondary">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="./js/nano-websocket-client.js"></script>
    <script>
        const { createApp, ref, computed, onMounted, onUnmounted } = Vue;

        const app = createApp({
            setup() {
                // å“åº”å¼æ•°æ®
                const currentView = ref('login'); // login, rooms, game
                const loading = ref(false);
                const error = ref('');
                const success = ref('');

                // ç”¨æˆ·è®¤è¯
                const isLogin = ref(true);
                const currentUser = ref(null);
                const authForm = ref({
                    name: '',
                    password: '',
                    age: 18
                });

                // æˆ¿é—´ç›¸å…³
                const rooms = ref([]);
                const currentRoom = ref(null);
                const showCreateRoomModal = ref(false);
                const showJoinRoomModal = ref(false);
                const joinRoomPassword = ref('');
                const selectedRoom = ref(null);
                const createRoomForm = ref({
                    name: '',
                    type: '0',
                    password: ''
                });

                // æ¸¸æˆç›¸å…³
                const gameState = ref(null);
                const playerHand = ref([]);
                const selectedCards = ref([]);
                const playerReady = ref(false);
                const nano = ref(null);

                // è®¡ç®—å±æ€§
                const isMyTurn = computed(() => {
                    if (!gameState.value || !currentUser.value) return false;
                    const myPlayer = gameState.value.players?.find(p => p && p.username === currentUser.value.name);
                    return myPlayer && myPlayer.position === gameState.value.current_turn;
                });

                const myPlayerPosition = computed(() => {
                    if (!gameState.value || !currentUser.value) return -1;
                    const myPlayer = gameState.value.players?.find(p => p && p.username === currentUser.value.name);
                    return myPlayer ? myPlayer.position : -1;
                });

                const allPlayersReady = computed(() => {
                    if (!gameState.value || !gameState.value.players) return false;
                    const players = gameState.value.players.filter(p => p !== null);
                    return players.length === 3 && players.every(p => p.is_ready);
                });

                // nanoç›¸å…³æ–¹æ³•
                const initNano = () => {
                    nano.value = window.nano;

                    nano.value.init({
                        host: "127.0.0.1",
                        port: 3250,
                        path: "/nano",
                        log: false,
                        user: {},
                        handshakeCallback: function() {
                            console.log('nanoæ¡æ‰‹å®Œæˆ');
                        }
                    }, function() {
                        console.log('nanoè¿æ¥æˆåŠŸ');
                    });
                };

                const request = (route, data) => {
                    return new Promise((resolve, reject) => {
                        nano.value.request(route, data, function(response) {
                            resolve(response);
                        });
                    });
                };

                // è®¤è¯ç›¸å…³æ–¹æ³•
                const submitAuth = async () => {
                    if (!authForm.value.name || !authForm.value.password) {
                        error.value = 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯';
                        return;
                    }

                    loading.value = true;
                    error.value = '';
                    success.value = '';

                    try {
                        const route = isLogin.value ? 'user.Login' : 'user.Signup';
                        const response = await request(route, authForm.value);

                        if (response.code === 200) {
                            success.value = response.message;
                            if (isLogin.value) {
                                currentUser.value = response.data;
                                currentView.value = 'rooms';
                                await refreshRooms();
                            } else {
                                success.value = 'æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•';
                                isLogin.value = true;
                                authForm.value.password = '';
                            }
                        } else {
                            error.value = response.message || 'æ“ä½œå¤±è´¥';
                        }
                    } catch (err) {
                        error.value = 'ç½‘ç»œé”™è¯¯ï¼š' + err.message;
                    } finally {
                        loading.value = false;
                    }
                };

                const toggleAuthMode = () => {
                    isLogin.value = !isLogin.value;
                    error.value = '';
                    success.value = '';
                    authForm.value.password = '';
                };

                const logout = () => {
                    currentUser.value = null;
                    currentView.value = 'login';
                    currentRoom.value = null;
                    gameState.value = null;
                    playerHand.value = [];
                };

                // æˆ¿é—´ç›¸å…³æ–¹æ³•
                const refreshRooms = async () => {
                    loading.value = true;
                    try {
                        const response = await request('room.GetRoomList', {
                            page: 1,
                            size: 50,
                            type: 0
                        });

                        if (response.code === 200) {
                            rooms.value = response.data.rooms || [];
                        } else {
                            error.value = response.message || 'è·å–æˆ¿é—´åˆ—è¡¨å¤±è´¥';
                        }
                    } catch (err) {
                        error.value = 'ç½‘ç»œé”™è¯¯ï¼š' + err.message;
                    } finally {
                        loading.value = false;
                    }
                };

                const createRoom = async () => {
                    if (!createRoomForm.value.name) {
                        error.value = 'è¯·è¾“å…¥æˆ¿é—´åç§°';
                        return;
                    }

                    loading.value = true;
                    error.value = '';

                    try {
                        const response = await request('room.CreateRoom', {
                            name: createRoomForm.value.name,
                            type: parseInt(createRoomForm.value.type),
                            password: createRoomForm.value.password
                        });

                        if (response.code === 200) {
                            currentRoom.value = response.data;
                            currentView.value = 'game';
                            showCreateRoomModal.value = false;
                            createRoomForm.value = { name: '', type: '0', password: '' };
                            await getGameState();
                            startGameStatePolling();
                        } else {
                            error.value = response.message || 'åˆ›å»ºæˆ¿é—´å¤±è´¥';
                        }
                    } catch (err) {
                        error.value = 'ç½‘ç»œé”™è¯¯ï¼š' + err.message;
                    } finally {
                        loading.value = false;
                    }
                };

                const joinRoom = (room) => {
                    selectedRoom.value = room;
                    if (room.has_password) {
                        showJoinRoomModal.value = true;
                        joinRoomPassword.value = '';
                    } else {
                        doJoinRoom();
                    }
                };

                const doJoinRoom = async () => {
                    loading.value = true;
                    error.value = '';

                    try {
                        const response = await request('room.JoinRoom', {
                            room_id: selectedRoom.value.id,
                            password: joinRoomPassword.value
                        });

                        if (response.code === 200) {
                            currentRoom.value = response.data;
                            currentView.value = 'game';
                            showJoinRoomModal.value = false;
                            await getGameState();
                            startGameStatePolling();
                        } else {
                            error.value = response.message || 'åŠ å…¥æˆ¿é—´å¤±è´¥';
                        }
                    } catch (err) {
                        error.value = 'ç½‘ç»œé”™è¯¯ï¼š' + err.message;
                    } finally {
                        loading.value = false;
                    }
                };

                const leaveRoom = async () => {
                    if (!currentRoom.value) return;

                    try {
                        await request('room.LeaveRoom', {
                            room_id: currentRoom.value.id
                        });
                        currentRoom.value = null;
                        currentView.value = 'rooms';
                        gameState.value = null;
                        playerHand.value = [];
                        stopGameStatePolling();
                        await refreshRooms();
                    } catch (err) {
                        error.value = 'ç¦»å¼€æˆ¿é—´å¤±è´¥ï¼š' + err.message;
                    }
                };

                // æ¸¸æˆç›¸å…³æ–¹æ³•
                const getGameState = async () => {
                    if (!currentRoom.value) return;

                    try {
                        const response = await request('game.GetGameState', {
                            room_id: currentRoom.value.id
                        });

                        if (response.code === 200) {
                            gameState.value = response.data;

                            // è·å–ç©å®¶æ‰‹ç‰Œ
                            const handResponse = await request('game.GetPlayerHand', {
                                room_id: currentRoom.value.id
                            });

                            if (handResponse.code === 200) {
                                playerHand.value = handResponse.data.cards || [];
                            }

                            // æ£€æŸ¥ç©å®¶å‡†å¤‡çŠ¶æ€
                            const myPlayer = gameState.value.players?.find(p => p && p.username === currentUser.value.name);
                            if (myPlayer) {
                                playerReady.value = myPlayer.is_ready;
                            }
                        }
                    } catch (err) {
                        console.error('è·å–æ¸¸æˆçŠ¶æ€å¤±è´¥:', err);
                    }
                };

                const toggleReady = async () => {
                    try {
                        const response = await request('room.SetReady', {
                            room_id: currentRoom.value.id,
                            ready: !playerReady.value
                        });

                        if (response.code === 200) {
                            playerReady.value = !playerReady.value;
                            await getGameState();
                        } else {
                            error.value = response.message || 'è®¾ç½®å‡†å¤‡çŠ¶æ€å¤±è´¥';
                        }
                    } catch (err) {
                        error.value = 'ç½‘ç»œé”™è¯¯ï¼š' + err.message;
                    }
                };

                const startGame = async () => {
                    try {
                        const response = await request('room.StartGame', {
                            room_id: currentRoom.value.id
                        });

                        if (response.code === 200) {
                            await getGameState();
                        } else {
                            error.value = response.message || 'å¼€å§‹æ¸¸æˆå¤±è´¥';
                        }
                    } catch (err) {
                        error.value = 'ç½‘ç»œé”™è¯¯ï¼š' + err.message;
                    }
                };

                const callLandlord = async (call) => {
                    try {
                        const response = await request('game.CallLandlord', {
                            room_id: currentRoom.value.id,
                            call: call
                        });

                        if (response.code === 200) {
                            await getGameState();
                        } else {
                            error.value = response.message || 'å«åœ°ä¸»å¤±è´¥';
                        }
                    } catch (err) {
                        error.value = 'ç½‘ç»œé”™è¯¯ï¼š' + err.message;
                    }
                };

                const toggleCardSelection = (index) => {
                    const pos = selectedCards.value.indexOf(index);
                    if (pos > -1) {
                        selectedCards.value.splice(pos, 1);
                    } else {
                        selectedCards.value.push(index);
                    }
                };

                const playCards = async () => {
                    if (selectedCards.value.length === 0) return;

                    const cards = selectedCards.value.map(index => playerHand.value[index]);

                    try {
                        const response = await request('game.PlayCards', {
                            room_id: currentRoom.value.id,
                            cards: cards
                        });

                        if (response.code === 200) {
                            selectedCards.value = [];
                            await getGameState();
                        } else {
                            error.value = response.message || 'å‡ºç‰Œå¤±è´¥';
                        }
                    } catch (err) {
                        error.value = 'ç½‘ç»œé”™è¯¯ï¼š' + err.message;
                    }
                };

                const passTurn = async () => {
                    try {
                        const response = await request('game.PassTurn', {
                            room_id: currentRoom.value.id
                        });

                        if (response.code === 200) {
                            await getGameState();
                        } else {
                            error.value = response.message || 'è¿‡ç‰Œå¤±è´¥';
                        }
                    } catch (err) {
                        error.value = 'ç½‘ç»œé”™è¯¯ï¼š' + err.message;
                    }
                };

                // å·¥å…·æ–¹æ³•
                const formatCard = (card) => {
                    const suits = { 1: 'â™ ', 2: 'â™¥', 3: 'â™¦', 4: 'â™£', 5: 'ç‹' };
                    const values = {
                        3: '3', 4: '4', 5: '5', 6: '6', 7: '7', 8: '8', 9: '9', 10: '10',
                        11: 'J', 12: 'Q', 13: 'K', 14: 'A', 15: '2',
                        16: 'å°ç‹', 17: 'å¤§ç‹'
                    };

                    if (card.suit === 5) {
                        return values[card.value];
                    }
                    return suits[card.suit] + values[card.value];
                };

                const getCardColor = (card) => {
                    if (card.suit === 2 || card.suit === 3) { // çº¢æ¡ƒï¼Œæ–¹å—
                        return 'red';
                    }
                    return 'black';
                };

                // å®šæ—¶åˆ·æ–°æ¸¸æˆçŠ¶æ€
                let gameStateInterval = null;
                const startGameStatePolling = () => {
                    if (gameStateInterval) clearInterval(gameStateInterval);
                    gameStateInterval = setInterval(() => {
                        if (currentView.value === 'game' && currentRoom.value) {
                            getGameState();
                        }
                    }, 2000);
                };

                const stopGameStatePolling = () => {
                    if (gameStateInterval) {
                        clearInterval(gameStateInterval);
                        gameStateInterval = null;
                    }
                };

                // æ¸…é™¤é”™è¯¯ä¿¡æ¯
                const clearError = () => {
                    error.value = '';
                };

                // ç”Ÿå‘½å‘¨æœŸ
                onMounted(() => {
                    initNano();

                    // å®šæ—¶æ¸…é™¤é”™è¯¯ä¿¡æ¯
                    setInterval(() => {
                        if (error.value) {
                            setTimeout(clearError, 3000);
                        }
                    }, 100);
                });

                onUnmounted(() => {
                    stopGameStatePolling();
                });

                return {
                    // æ•°æ®
                    currentView, loading, error, success,
                    isLogin, currentUser, authForm,
                    rooms, currentRoom, showCreateRoomModal, showJoinRoomModal,
                    joinRoomPassword, createRoomForm,
                    gameState, playerHand, selectedCards, playerReady,
                    isMyTurn, myPlayerPosition, allPlayersReady,

                    // æ–¹æ³•
                    submitAuth, toggleAuthMode, logout,
                    refreshRooms, createRoom, joinRoom, doJoinRoom, leaveRoom,
                    getGameState, toggleReady, startGame, callLandlord,
                    toggleCardSelection, playCards, passTurn, formatCard, getCardColor
                };
            }
        });

        app.mount('#app');
    </script>
</body>
</html>