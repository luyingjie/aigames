<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>斗地主游戏</title>
    <link rel="stylesheet" href="./css/style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>🃏 斗地主游戏</h1>
                <p v-if="currentUser">欢迎，{{ currentUser.name }}！</p>
            </div>

            <!-- 登录/注册界面 -->
            <div v-if="currentView === 'login'" class="card">
                <div style="max-width: 400px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 30px;">
                        {{ isLogin ? '登录' : '注册' }}
                    </h2>

                    <div v-if="error" class="error">{{ error }}</div>
                    <div v-if="success" class="success">{{ success }}</div>

                    <form @submit.prevent="submitAuth">
                        <div class="form-group">
                            <label>用户名</label>
                            <input v-model="authForm.name" type="text" required>
                        </div>
                        <div class="form-group">
                            <label>密码</label>
                            <input v-model="authForm.password" type="password" required>
                        </div>
                        <div v-if="!isLogin" class="form-group">
                            <label>年龄</label>
                            <input v-model="authForm.age" type="number" min="1" max="150" required>
                        </div>
                        <div style="text-align: center;">
                            <button type="submit" class="btn btn-primary" :disabled="loading">
                                {{ loading ? '处理中...' : (isLogin ? '登录' : '注册') }}
                            </button>
                        </div>
                    </form>

                    <div style="text-align: center; margin-top: 20px;">
                        <span>{{ isLogin ? '没有账号？' : '已有账号？' }}</span>
                        <a href="#" @click.prevent="toggleAuthMode" style="color: #2196F3;">
                            {{ isLogin ? '立即注册' : '立即登录' }}
                        </a>
                    </div>
                </div>
            </div>

            <!-- 房间列表界面 -->
            <div v-if="currentView === 'rooms'" class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>房间列表</h2>
                    <div>
                        <button @click="showCreateRoomModal = true" class="btn btn-primary">创建房间</button>
                        <button @click="refreshRooms" class="btn btn-secondary">刷新</button>
                        <button @click="logout" class="btn btn-danger">退出登录</button>
                    </div>
                </div>

                <div v-if="loading" class="loading">加载中...</div>

                <div v-if="rooms.length === 0 && !loading" style="text-align: center; color: #666; padding: 40px;">
                    暂无房间，点击"创建房间"开始游戏
                </div>

                <div v-else class="room-list">
                    <div v-for="room in rooms" :key="room.id" class="room-card">
                        <div class="room-header">
                            <div class="room-name">{{ room.name }}</div>
                            <div :class="['room-status', 'status-' + room.status]">
                                {{ room.status_name }}
                            </div>
                        </div>
                        <div style="margin: 10px 0;">
                            <div>房主: {{ room.owner }}</div>
                            <div>玩家: {{ room.player_count }}/{{ room.max_players }}</div>
                            <div v-if="room.has_password">🔒 需要密码</div>
                        </div>
                        <div style="text-align: center;">
                            <button @click="joinRoom(room)" class="btn btn-secondary"
                                    :disabled="room.player_count >= room.max_players || room.status === 2">
                                {{ room.status === 2 ? '游戏中' : (room.player_count >= room.max_players ? '房间已满' : '加入房间') }}
                            </button>
                            <button v-if="room.owner === currentUser.name" 
                                    @click="deleteRoom(room)" 
                                    class="btn btn-danger"
                                    style="margin-left: 10px;">
                                删除
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 游戏界面 -->
            <div v-if="currentView === 'game'">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>房间: {{ currentRoom?.name }}</h2>
                        <div>
                            <button v-if="gameState?.status === 0 && currentRoom?.owner === currentUser?.name"
                                    @click="startGame" class="btn btn-primary"
                                    :disabled="!allPlayersReady">开始游戏</button>
                            <button v-if="gameState?.status === 0"
                                    @click="toggleReady"
                                    :class="['btn', playerReady ? 'btn-danger' : 'btn-primary']">
                                {{ playerReady ? '取消准备' : '准备' }}
                            </button>
                            <button @click="leaveRoom" class="btn btn-danger">离开房间</button>
                        </div>
                    </div>

                    <div v-if="error" class="error">{{ error }}</div>
                    
                    <!-- 游戏结束提示 -->
                    <div v-if="gameState?.status === 5" class="success" style="text-align: center; padding: 20px; font-size: 1.2em;">
                        <h3>🎉 游戏结束！</h3>
                        <p>获胜者: 玩家{{ (gameState.winner + 1) }} ({{ getPlayerNameByPosition(gameState.winner) }})</p>
                        <p>{{ gameState.status_name }}</p>
                    </div>

                    <!-- 游戏桌面 -->
                    <div class="game-table">
                        <!-- 玩家位置 (根据当前用户位置调整显示) -->
                        <div class="player-position position-bottom" :class="{ landlord: getPlayerByPosition(0)?.role === 1 }">
                            <div v-if="getPlayerByPosition(0)">
                                {{ getPlayerByPosition(0).username }}
                                <span v-if="getPlayerByPosition(0).username === currentUser.name">(你)</span>
                                <span v-if="getPlayerByPosition(0).is_ai" style="color: #ff9800;">🤖 AI</span>
                                <div>{{ getPlayerByPosition(0).role_name }}</div>
                                <div>手牌: {{ getPlayerByPosition(0).card_count }}</div>
                                <div v-if="getPlayerByPosition(0).is_ready">✓ 已准备</div>
                            </div>
                            <div v-else>等待玩家...</div>
                        </div>

                        <div class="player-position position-left" :class="{ landlord: getPlayerByPosition(1)?.role === 1 }">
                            <div v-if="getPlayerByPosition(1)">
                                {{ getPlayerByPosition(1).username }}
                                <span v-if="getPlayerByPosition(1).is_ai" style="color: #ff9800;">🤖 AI</span>
                                <div>{{ getPlayerByPosition(1).role_name }}</div>
                                <div>手牌: {{ getPlayerByPosition(1).card_count }}</div>
                                <div v-if="getPlayerByPosition(1).is_ready">✓ 已准备</div>
                            </div>
                            <div v-else>等待玩家...</div>
                        </div>

                        <div class="player-position position-right" :class="{ landlord: getPlayerByPosition(2)?.role === 1 }">
                            <div v-if="getPlayerByPosition(2)">
                                {{ getPlayerByPosition(2).username }}
                                <span v-if="getPlayerByPosition(2).is_ai" style="color: #ff9800;">🤖 AI</span>
                                <div>{{ getPlayerByPosition(2).role_name }}</div>
                                <div>手牌: {{ getPlayerByPosition(2).card_count }}</div>
                                <div v-if="getPlayerByPosition(2).is_ready">✓ 已准备</div>
                            </div>
                            <div v-else>等待玩家...</div>
                        </div>

                        <!-- 游戏状态 -->
                        <div class="game-center">
                            <div>{{ gameState?.status_name || '等待开始' }}</div>
                            <div v-if="gameState?.current_turn !== undefined">
                                当前回合: 玩家{{ gameState.current_turn + 1 }} ({{ getPlayerNameByPosition(gameState.current_turn) }})
                            </div>
                            <div v-if="gameState?.landlord_cards && gameState.landlord_cards.length > 0">
                                <div style="margin-top: 10px;">地主牌:</div>
                                <div class="playing-cards" style="margin: 0;">
                                    <div v-for="(card, index) in gameState.landlord_cards" :key="'landlord-' + index"
                                         :class="['poker-card', getCardColorClass(card)]">
                                        <div class="card-top">{{ formatCardValue(card) }}</div>
                                        <div class="card-center">{{ formatCardSuit(card) }}</div>
                                        <div class="card-bottom">{{ formatCardValue(card) }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 上一次出牌 -->
                    <div v-if="gameState?.last_play_cards && gameState.last_play_cards.length > 0" class="last-cards">
                        <div class="last-cards-title">上一手牌 (玩家{{ gameState.last_player + 1 }} - {{ getPlayerNameByPosition(gameState.last_player) }})</div>
                        <div class="playing-cards">
                            <div v-for="(card, index) in gameState.last_play_cards" :key="'last-' + index"
                                 :class="['poker-card', getCardColorClass(card)]">
                                <div class="card-top">{{ formatCardValue(card) }}</div>
                                <div class="card-center">{{ formatCardSuit(card) }}</div>
                                <div class="card-bottom">{{ formatCardValue(card) }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- 玩家手牌 -->
                    <div v-if="playerHand && playerHand.length > 0" style="margin-top: 30px;">
                        <h3>我的手牌 ({{ playerHand.length }}张)</h3>
                        <div class="playing-cards">
                            <div v-for="(card, index) in playerHand" :key="index"
                                 :class="['poker-card', getCardColorClass(card), { selected: selectedCards.includes(index) }]"
                                 @click="toggleCardSelection(index)">
                                <div class="card-top">{{ formatCardValue(card) }}</div>
                                <div class="card-center">{{ formatCardSuit(card) }}</div>
                                <div class="card-bottom">{{ formatCardValue(card) }}</div>
                            </div>
                        </div>

                        <div style="margin-top: 20px; text-align: center;" v-if="isMyTurn && gameState?.status === 4">
                            <button @click="playCards" class="btn btn-primary"
                                    :disabled="selectedCards.length === 0">出牌</button>
                            <button @click="passTurn" class="btn btn-secondary"
                                    v-if="gameState?.last_play_cards && gameState.last_play_cards.length > 0 && gameState.last_player !== myPlayerPosition">过牌</button>
                        </div>
                    </div>

                    <!-- 叫地主按钮 -->
                    <div v-if="gameState?.status === 3 && isMyTurn" style="text-align: center; margin-top: 20px;">
                        <h3>是否叫地主？</h3>
                        <button @click="callLandlord(true)" class="btn btn-primary">叫地主</button>
                        <button @click="callLandlord(false)" class="btn btn-secondary">不叫</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 创建房间模态框 -->
        <div :class="['modal', { show: showCreateRoomModal }]">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px;">创建房间</h3>

                <div v-if="error" class="error">{{ error }}</div>

                <form @submit.prevent="createRoom">
                    <div class="form-group">
                        <label>房间名称</label>
                        <input v-model="createRoomForm.name" type="text" required>
                    </div>
                    <div class="form-group">
                        <label>房间类型</label>
                        <select v-model="createRoomForm.type">
                            <option value="0">公开房间</option>
                            <option value="1">私人房间</option>
                        </select>
                    </div>
                    <div v-if="createRoomForm.type === '1'" class="form-group">
                        <label>房间密码</label>
                        <input v-model="createRoomForm.password" type="password">
                    </div>
                    <div class="form-group">
                        <label>AI玩家数量</label>
                        <select v-model="createRoomForm.ai_count">
                            <option value="0">无AI玩家</option>
                            <option value="1">1个AI玩家</option>
                            <option value="2">2个AI玩家</option>
                        </select>
                        <small style="display: block; color: #666; margin-top: 5px;">
                            添加AI玩家可以让你独自练习或在人数不足时游戏
                        </small>
                    </div>
                    <div style="text-align: center;">
                        <button type="submit" class="btn btn-primary" :disabled="loading">
                            {{ loading ? '创建中...' : '创建房间' }}
                        </button>
                        <button type="button" @click="showCreateRoomModal = false" class="btn btn-secondary">取消</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 加入房间密码输入框 -->
        <div :class="['modal', { show: showJoinRoomModal }]">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px;">输入房间密码</h3>

                <div v-if="error" class="error">{{ error }}</div>

                <form @submit.prevent="doJoinRoom">
                    <div class="form-group">
                        <label>密码</label>
                        <input v-model="joinRoomPassword" type="password" required>
                    </div>
                    <div style="text-align: center;">
                        <button type="submit" class="btn btn-primary" :disabled="loading">
                            {{ loading ? '加入中...' : '加入房间' }}
                        </button>
                        <button type="button" @click="showJoinRoomModal = false" class="btn btn-secondary">取消</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="./js/protocol.js"></script>
    <script src="./js/nano-websocket-client.js"></script>
    <script src="./js/app.js"></script>
</body>
</html>